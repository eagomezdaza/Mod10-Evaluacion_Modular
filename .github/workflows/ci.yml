
name: Evaluacion Modular CI

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
    paths:
      - "src/**"
      - "tests/**"
      - "docker/**"
      - "Makefile"
      - "requirements.txt"
      - ".github/workflows/ci.yml"
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    env:
      PORT: 5000
      MODEL_PATH: src/model/modelo_breast.pkl
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            pip-${{ runner.os }}-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Train model
        run: |
          python src/train_breast_cancer.py

      - name: Start API (Gunicorn, factory, background)
        env:
          PORT: ${{ env.PORT }}
          MODEL_PATH: ${{ env.MODEL_PATH }}
        run: |
          gunicorn 'src.app:create_app()' -w 2 -b 127.0.0.1:${PORT} > api.log 2>&1 &
          echo $! > app.pid
          for i in $(seq 1 30); do
            if curl -fsS "http://127.0.0.1:${PORT}/health" >/dev/null 2>&1; then
              echo "âœ… API healthy en intento $i"
              break
            fi
            echo "â³ Esperando API... (intento $i)"
            sleep 2
            if [ "$i" -eq 30 ]; then
              echo "âŒ La API no alcanzÃ³ estado healthy a tiempo."
              echo "=== api.log (Ãºltimas 200 lÃ­neas) ==="
              tail -n 200 api.log || true
              exit 1
            fi
          done

      - name: Smoke tests
        run: |
          set -e
          curl -f "http://127.0.0.1:${{ env.PORT }}/health"
          cat > sample_test.json << 'EOF'
          {
            "features": [17.99,10.38,122.8,1001.0,0.1184,0.2776,0.3001,0.1471,0.2419,0.07871,
                         1.095,0.9053,8.589,153.4,0.006399,0.04904,0.05373,0.01587,0.03003,0.006193,
                         25.38,17.33,184.6,2019.0,0.1622,0.6656,0.7119,0.2654,0.4601,0.1189]
          }
          EOF
          curl -f -X POST "http://127.0.0.1:${{ env.PORT }}/predict" \
               -H "Content-Type: application/json" \
               --data @sample_test.json

      - name: Mostrar logs de la API
        if: always()
        run: |
          echo "=== api.log (Ãºltimas 150 lÃ­neas) ==="
          tail -n 150 api.log || true

      - name: Detener API
        if: always()
        run: |
          [ -f app.pid ] && kill "$(cat app.pid)" 2>/dev/null || true

  deploy-azure:
    name: Deploy â€” Azure Container Apps
    needs: [ build-and-test ]
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    env:
      # === Environment EXISTENTE (lo listaste con az containerapp env list) ===
      RG_ENV: rg-evalmod-aca2
      ENV_NAME: env-evalmod2
      LOCATION: eastus

      # === RG donde quieres/estÃ¡ la APP (puede ser distinto al del ENV) ===
      RG_APP: rg-evalmod
      APP: evalmod-api

      # Imagen y app config
      IMAGE: em-api
      TAG: ${{ github.sha }}
      PORT: 5000
      MODEL_PATH: src/model/modelo_breast.pkl

      # Registry desde Secrets
      ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
      ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
      ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}

      # El build&push ya lo hace este job (dejamos el script en modo SKIP_BUILD=1)
      SKIP_BUILD: "1"

    steps:
      - name: Preflight secrets
        env:
          HAS_AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
          HAS_ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
          HAS_ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
          HAS_ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}
        run: |
          missing=0
          for v in HAS_AZURE_CREDENTIALS HAS_ACR_LOGIN_SERVER HAS_ACR_USERNAME HAS_ACR_PASSWORD; do
            if [ -z "${!v}" ]; then echo "âŒ Falta secret: $v"; missing=1; fi
          done
          [ "$missing" -eq 1 ] && { echo "Aborto: faltan secrets."; exit 1; }
          echo "âœ… Secrets presentes"

      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Azure login (Service Principal)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Install Container Apps CLI & check providers (no register)
        run: |
          az extension add --name containerapp --upgrade
          for NS in Microsoft.App Microsoft.OperationalInsights; do
            STATE=$(az provider show --namespace $NS --query registrationState -o tsv || echo "Unknown")
            echo "$NS: $STATE"
            if [ "$STATE" != "Registered" ]; then
              echo "âŒ Provider $NS no estÃ¡ 'Registered'. RegÃ­stralo 1 vez con tu usuario:"
              echo "   az provider register --namespace $NS"
              exit 1
            fi
          done

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & Push to ACR
        run: |
          az acr login -n "${{ env.ACR_LOGIN_SERVER%%.* }}"
          docker build -f docker/Dockerfile -t "${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE }}:${{ env.TAG }}" .
          docker push "${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE }}:${{ env.TAG }}"

      - name: Deploy to Azure Container Apps (script)
        run: bash scripts/deploy_azure.sh

      - name: Mostrar URL pÃºblica
        run: |
          FQDN=$(az containerapp show -g "${{ env.RG_APP }}" -n "${{ env.APP }}" --query properties.configuration.ingress.fqdn -o tsv 2>/dev/null || echo "no-disponible")
          echo "ğŸŒ URL pÃºblica: https://${FQDN}"

